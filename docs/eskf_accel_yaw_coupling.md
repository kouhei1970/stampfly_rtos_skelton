# ESKF 加速度姿勢更新におけるヨー結合問題

## 問題概要

機体を静置中に軽く触れて振動を与えると、地磁気センサーの値がほぼ変化していないにもかかわらず、ヨー推定値がジャンプする現象が発生。

**原因**: `updateAccelAttitude()` 関数において、機体が傾いている場合に加速度観測がヨー状態を更新してしまう。

---

## 理論的背景

### 1. 座標系と記号定義

```
NED座標系（World frame）:
  X = 北（North）
  Y = 東（East）
  Z = 下（Down）

Body座標系（機体座標）:
  x = 前（ノーズ方向）
  y = 右（スターボード）
  z = 下

重力ベクトル（世界座標）:
  g_world = [0, 0, g]^T   （g ≈ 9.81 m/s²）

回転行列 R:
  World → Body: v_body = R^T × v_world
  Body → World: v_world = R × v_body

クォータニオン q = [q0, q1, q2, q3] = [w, x, y, z]:
  回転行列 R の要素は q から計算
```

### 2. ESKF状態ベクトル

```
状態ベクトル x（15次元）:
  x[0-2]   = 位置      (pos_x, pos_y, pos_z)    [m]
  x[3-5]   = 速度      (vel_x, vel_y, vel_z)    [m/s]
  x[6-8]   = 姿勢誤差  (δθx, δθy, δθz)          [rad]
            （ATT_X=6: ロール誤差, ATT_Y=7: ピッチ誤差, ATT_Z=8: ヨー誤差）
  x[9-11]  = ジャイロバイアス (bg_x, bg_y, bg_z) [rad/s]
  x[12-14] = 加速度バイアス   (ba_x, ba_y, ba_z) [m/s²]
```

### 3. 加速度計の観測モデル

機体が静止している場合、加速度計は重力の反作用を測定する：

```
観測モデル:
  h(x) = R^T × [0, 0, -g]^T + accel_bias

ここで:
  R^T = 回転行列の転置（World → Body変換）
  g   = 重力加速度（≈9.81 m/s²）
```

R^T の第3列を使って展開：

```
h = [-g × R20, -g × R21, -g × R22]^T

ここで（クォータニオンから計算）:
  R20 = 2(q1×q3 - q0×q2)      ≈ -sin(pitch)         （小角度近似）
  R21 = 2(q2×q3 + q0×q1)      ≈ sin(roll)×cos(pitch)
  R22 = 1 - 2(q1² + q2²)      ≈ cos(roll)×cos(pitch)
```

---

## H行列（観測ヤコビアン）の導出

### 1. 姿勢誤差に対する微分

姿勢誤差 δθ = [δθx, δθy, δθz]^T に対する観測の微分：

```
∂h/∂δθ = [h]× （hの歪対称行列）

ここで h = [hx, hy, hz]^T = [-g×R20, -g×R21, -g×R22]^T

[h]× = |  0   -hz   hy |   |  0      g×R22  -g×R21 |
       | hz    0   -hx | = | -g×R22   0      g×R20 |
       |-hy   hx    0  |   |  g×R21  -g×R20   0    |
```

### 2. コードでのH行列実装

`eskf.cpp:1285-1287`:

```cpp
// H行列の姿勢部分（列6,7,8 = ATT_X, ATT_Y, ATT_Z）
//                    ATT_X      ATT_Y      ATT_Z
float H06 = 0.0f,     H07 = g*R22,    H08 = -g*R21;  // 行0（ax観測）
float H16 = -g*R22,   H17 = 0.0f,     H18 = g*R20;   // 行1（ay観測）
float H26 = g*R21,    H27 = -g*R20,   H28 = 0.0f;    // 行2（az観測）
```

---

## 問題の数学的解析

### 1. ATT_Z（ヨー誤差）に対する感度

列8（ATT_Z）の要素：

```
H08 = -g × R21 = -g × sin(roll) × cos(pitch)
H18 =  g × R20 = -g × sin(pitch)
H28 = 0
```

### 2. 水平状態（roll=0, pitch=0）の場合

```
R20 = 0, R21 = 0, R22 = 1

H行列の列8:
  H08 = 0
  H18 = 0
  H28 = 0

→ 加速度観測はヨーに影響しない（正しい動作）
```

### 3. 傾斜状態（例：roll=10°, pitch=0°）の場合

```
R20 ≈ 0
R21 ≈ sin(10°) ≈ 0.174
R22 ≈ cos(10°) ≈ 0.985

H行列の列8:
  H08 = -9.81 × 0.174 = -1.71
  H18 = 0
  H28 = 0

→ ax観測がヨー誤差推定に影響する！
```

### 4. カルマン更新における影響

カルマンゲイン K と残差 y によるヨー更新：

```
dx[ATT_Z] = K[8][0]×y0 + K[8][1]×y1 + K[8][2]×y2

ここで:
  y0 = ax_measured - ax_expected  （X軸加速度残差）
  y1 = ay_measured - ay_expected  （Y軸加速度残差）
  y2 = az_measured - az_expected  （Z軸加速度残差）
```

K[8][*] は H08, H18 が非ゼロの場合、共分散行列 P を通じて非ゼロになる。

---

## 具体的な数値例

### シナリオ

```
条件:
  - roll = 5°, pitch = 0°
  - 静止中に振動発生
  - 加速度計 ax に 0.5 m/s² のスパイク

計算:
  R21 = sin(5°) ≈ 0.087
  H08 = -9.81 × 0.087 ≈ -0.85

  y0 = 0.5 m/s²（振動によるスパイク）

  K[8][0] ≈ 0.01（典型的な値）と仮定

  dx[ATT_Z] = 0.01 × 0.5 = 0.005 rad ≈ 0.29°

結果:
  1回の振動でヨーが約0.3°ジャンプ
  連続振動で累積誤差が発生
```

---

## 物理的解釈

### なぜ加速度計はヨーを観測できないのか

```
加速度計が観測するもの:
  - 重力ベクトルの方向（どちらが「下」か）

重力ベクトルから分かること:
  - ロール角: 横方向の傾き
  - ピッチ角: 前後方向の傾き

重力ベクトルから分からないこと:
  - ヨー角: 鉛直軸周りの回転（重力は軸対称）

→ 理論上、加速度計観測はヨーに影響すべきでない
```

### H行列にヨー成分がある理由

```
数学的には:
  ∂h/∂δθ = [h]× は3×3の歪対称行列
  h が z軸方向でない場合（機体傾斜時）、全要素が結合

物理的には:
  これは「ヨーが変わると加速度観測も変わる」ことを意味するが、
  逆問題（加速度からヨーを推定）は解けない（可観測性の問題）

ESKFの問題:
  共分散行列 P の結合により、数値的にヨーが更新されてしまう
```

---

## 解決策

### 方法: ヨー更新の強制ゼロ化

`updateAccelAttitude()` 関数内で、ヨー誤差の更新を無効化：

```cpp
// 状態更新計算後、ヨー成分をゼロに
dx[ATT_Z] = 0.0f;  // 加速度観測ではヨーを更新しない
```

### 理論的根拠

1. 加速度計はヨーを可観測でない
2. ヨー推定は地磁気計（updateMag）とジャイロ積分（predict）に任せる
3. 加速度観測はロール・ピッチの補正のみに使用

### 代替案（検討）

1. **共分散行列の分離**: P の ATT_Z 行/列を加速度更新から除外
2. **閾値の厳格化**: `accel_motion_threshold` を小さくして振動時スキップ
3. **LPF追加**: 加速度にローパスフィルタを適用（Phase 3実装予定）

---

## 実装履歴

| 日付 | 変更 |
|------|------|
| 2025-12-31 | 問題特定・解析ドキュメント作成 |
| 2025-12-31 | dx[ATT_Z]=0 修正適用 |

---

## 関連ファイル

- `components/stampfly_eskf/eskf.cpp` - ESKF実装
- `docs/eskf_bias_estimation.md` - バイアス推定設計
- `docs/eskf_sensor_health.md` - センサーヘルスチェック設計
